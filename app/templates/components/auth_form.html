{# 
Auth Form Macro
Usage: 
{% from "components/auth_form.html" import auth_form %}
{{ auth_form("login", "/login-form", "Sign In", "Signing in...", 
             fields=[{"label": "Email", "name": "email", "type": "email"}]) }}
#}

{% macro auth_form(form_type, action, submit_text, loading_text, fields, errors=[], form_data={}, field_errors={}, checkboxes=[]) %}
{% from "components/form_input.html" import form_input %}
{% from "components/form_checkbox.html" import form_checkbox %}
{% from "components/button.html" import button %}

<div id="{{ form_type }}-form-container">
  {% if errors %}
  <div class="form-errors" role="alert" aria-live="polite">
    <ul>
      {% for error in errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <form class="auth-form" 
        action="{{ action }}" 
        method="post"
        hx-post="{{ action }}"
        hx-target="#{{ form_type }}-form-container"
        hx-swap="outerHTML"
        hx-indicator="#{{ form_type }}-spinner">
    
    {% for field in fields %}
    {{ form_input(
         field.label, 
         field.name, 
         type=field.type|default("text"),
         required=field.required|default(true),
         value=form_data[field.name] if form_data and field.name in form_data else "",
         error=field_errors[field.name][0] if field_errors and field.name in field_errors else ""
       ) }}
    {% endfor %}

    {% for checkbox in checkboxes %}
    {{ form_checkbox(
         checkbox.name,
         checkbox.label,
         required=checkbox.required|default(true),
         checked=form_data[checkbox.name] if form_data and checkbox.name in form_data else false,
         error=field_errors[checkbox.name][0] if field_errors and checkbox.name in field_errors else ""
       ) }}
    {% endfor %}

    {% if form_type == "register" and turnstile_site_key %}
    <div id="turnstile-container"></div>
    <script>
      (function() {
        function renderWidget() {
          var el = document.getElementById('turnstile-container');
          if (!el || el.hasChildNodes()) return;
          if (typeof turnstile !== 'undefined') {
            turnstile.render(el, { sitekey: '{{ turnstile_site_key }}', theme: 'auto' });
          }
        }
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', renderWidget);
        } else {
          setTimeout(renderWidget, 100);
        }
      })();
    </script>
    {% endif %}

    {{ button(submit_text, type="submit", hx_indicator="#" + form_type + "-spinner", loading_text=loading_text) }}
  </form>
</div>
{% endmacro %}
