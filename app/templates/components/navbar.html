{# 
Navbar Component
#}
{% from "components/nav_link.html" import nav_link %}
{% from "components/button.html" import link_button %}
{% from "components/dropdown.html" import dropdown %}
{% from "components/dark_mode_toggle.html" import dark_mode_toggle %}

<header class="navbar">

  <div class="logo">
    <a href="/">
      <img src="/brand/logos/press/press-logo-64.svg" alt="Scroll Press">
      Scroll Press
    </a>
  </div>
  
  <nav class="main-nav" aria-label="Main navigation">
    {{ nav_link("Browse", "/#browse") }}
    {{ nav_link("Recent", "/#recent") }}
    {{ nav_link("About", "/about") }}
    {{ nav_link("How It Works", "/how-it-works") }}
  </nav>
  
  <div class="auth-buttons">
    {{ dark_mode_toggle() }}
    {% if current_user %}
    {{ link_button("New Scroll", href="/upload", variant="primary") }}
    <div class="dropdown user-menu">
      <button class="user-menu-trigger" aria-haspopup="true" aria-expanded="false">
        <svg class="user-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="8" r="3" fill="currentColor"/>
          <path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="user-menu-label">{{ current_user.display_name }}</span>
      </button>
      
      <div class="dropdown-menu" role="menu">
        <a href="/dashboard" class="dropdown-item" role="menuitem">Dashboard</a>
        <form class="dropdown-form" action="/logout" method="post">
          <button type="submit" class="dropdown-item dropdown-action" role="menuitem">Logout</button>
        </form>
      </div>
    </div>
    {% else %}
    {{ link_button("New Scroll", href="/register", variant="primary") }}
    {{ link_button("Login", href="/login", variant="secondary") }}
    {% endif %}
  </div>

  <!-- Mobile controls -->
  <div class="mobile-controls">
    <div class="mobile-dark-mode-toggle">
      {{ dark_mode_toggle() }}
    </div>
    <button class="mobile-menu-toggle" aria-label="Toggle navigation menu" aria-expanded="false">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
  </div>

  <!-- Mobile navigation menu -->
  <nav class="mobile-nav" aria-label="Mobile navigation">
    <div class="mobile-nav-links">
      <a href="/#browse">Browse</a>
      <a href="/#recent">Recent</a>
      <a href="/about">About</a>
      <a href="/how-it-works">How It Works</a>
    </div>
    
    <div class="mobile-auth-buttons">
      {% if current_user %}
      {{ link_button("New Scroll", href="/upload", variant="primary") }}
      <a href="/dashboard" class="btn btn-secondary">Dashboard</a>
      <form action="/logout" method="post" style="margin: 0;">
        <button type="submit" class="btn btn-secondary" style="width: 100%;">Logout</button>
      </form>
      {% else %}
      {{ link_button("New Scroll", href="/register", variant="primary") }}
      {{ link_button("Login", href="/login", variant="secondary") }}
      {% endif %}
    </div>
  </div>

</header>

<script>
(function() {
  function initMobileMenu(element) {
    const mobileToggle = element.querySelector('.mobile-menu-toggle');
    const mobileNav = element.querySelector('.mobile-nav');
    const mobileBackdrop = document.querySelector('.mobile-nav-backdrop');

    if (!mobileToggle || !mobileNav) return;

    if (mobileToggle.dataset.mobileMenuInitialized) return;
    mobileToggle.dataset.mobileMenuInitialized = 'true';

    function closeMobileMenu() {
      mobileNav.classList.remove('open');
      if (mobileBackdrop) mobileBackdrop.classList.remove('open');
      mobileToggle.classList.remove('open');
      mobileToggle.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = 'auto';
    }

    function openMobileMenu() {
      mobileNav.classList.add('open');
      if (mobileBackdrop) mobileBackdrop.classList.add('open');
      mobileToggle.classList.add('open');
      mobileToggle.setAttribute('aria-expanded', 'true');
      document.body.style.overflow = 'hidden';
    }

    mobileToggle.addEventListener('click', function() {
      const isOpen = mobileNav.classList.contains('open');
      if (isOpen) {
        closeMobileMenu();
      } else {
        openMobileMenu();
      }
    });

    if (mobileBackdrop && !mobileBackdrop.dataset.backdropInitialized) {
      mobileBackdrop.dataset.backdropInitialized = 'true';
      mobileBackdrop.addEventListener('click', function() {
        closeMobileMenu();
      });
    }

    const mobileNavLinks = mobileNav.querySelectorAll('a, button[type="submit"]');
    mobileNavLinks.forEach(link => {
      if (link.dataset.navLinkInitialized) return;
      link.dataset.navLinkInitialized = 'true';
      link.addEventListener('click', function() {
        closeMobileMenu();
      });
    });
  }

  function initGlobalMobileMenuHandlers() {
    if (window.globalMobileMenuHandlersInitialized) return;
    window.globalMobileMenuHandlersInitialized = true;

    document.addEventListener('click', function(e) {
      const mobileToggle = document.querySelector('.mobile-menu-toggle');
      const mobileNav = document.querySelector('.mobile-nav');
      if (mobileToggle && mobileNav && !mobileToggle.contains(e.target) && !mobileNav.contains(e.target)) {
        mobileNav.classList.remove('open');
        const mobileBackdrop = document.querySelector('.mobile-nav-backdrop');
        if (mobileBackdrop) mobileBackdrop.classList.remove('open');
        mobileToggle.classList.remove('open');
        mobileToggle.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = 'auto';
      }
    });

    document.addEventListener('keydown', function(e) {
      const mobileNav = document.querySelector('.mobile-nav');
      const mobileToggle = document.querySelector('.mobile-menu-toggle');
      if (e.key === 'Escape' && mobileNav && mobileNav.classList.contains('open')) {
        mobileNav.classList.remove('open');
        const mobileBackdrop = document.querySelector('.mobile-nav-backdrop');
        if (mobileBackdrop) mobileBackdrop.classList.remove('open');
        if (mobileToggle) {
          mobileToggle.classList.remove('open');
          mobileToggle.setAttribute('aria-expanded', 'false');
        }
        document.body.style.overflow = 'auto';
      }
    });
  }

  document.body.addEventListener('htmx:load', function(evt) {
    initMobileMenu(evt.detail.elt);
    initGlobalMobileMenuHandlers();
  });

  document.addEventListener('DOMContentLoaded', function() {
    initMobileMenu(document.body);
    initGlobalMobileMenuHandlers();
  });
})();
</script>
