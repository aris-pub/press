{% extends "base.html" %}
{% from "components/button.html" import button %}
{% from "components/scroll_card.html" import scroll_card %}
{% from "components/subject_card.html" import subject_card %}
{% from "components/search_form.html" import search_form %}

{% block title %}Home - Scroll Press{% endblock %}

{% block content %}
{% if show_verification_notice %}
<div class="verification-notice">
  <div class="verification-notice-content">
    <svg class="verification-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
    </svg>
    <div>
      <strong>Email Verification Required</strong>
      <p>Please check your email and click the verification link to access all features. Didn't receive it? <a href="/resend-verification" class="resend-link">Resend verification email</a></p>
    </div>
  </div>
</div>

<style>
.verification-notice {
  background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
  border-left: 4px solid #F59E0B;
  margin: 1.5rem auto;
  max-width: 1200px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.verification-notice-content {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  padding: 1.25rem;
}

.verification-icon {
  width: 32px;
  height: 32px;
  color: #F59E0B;
  flex-shrink: 0;
  margin-top: 0.125rem;
}

.verification-notice strong {
  display: block;
  color: #92400E;
  font-size: 1.125rem;
  margin-bottom: 0.5rem;
}

.verification-notice p {
  color: #78350F;
  margin: 0;
  font-size: 0.95rem;
  line-height: 1.5;
}

.resend-link {
  color: #D97706;
  text-decoration: underline;
  font-weight: 600;
}

.resend-link:hover {
  color: #B45309;
}

@media (max-width: 768px) {
  .verification-notice {
    margin: 1rem;
  }

  .verification-notice-content {
    gap: 0.75rem;
  }

  .verification-icon {
    width: 24px;
    height: 24px;
  }

  .verification-notice strong {
    font-size: 1rem;
  }

  .verification-notice p {
    font-size: 0.875rem;
  }
}
</style>
{% endif %}
<div class="hero">
  <div class="hero-title">
    <img src="/static/images/press-logo-64.svg" alt="Scroll Press" width="40" height="40">
    <h1>Scroll Press</h1>
  </div>
  <p>Open access to research preprints in web-native formats</p>
  
  <div class="search-box">
    {{ search_form(button_class="search-btn-override") }}
    <div class="search-help">
      Search includes titles, authors, abstracts, and full text
    </div>
  </div>
</div>

<div class="subjects" id="browse">
  <div class="subjects-header">
    <h2>Browse by Subject</h2>
    <button id="show-all-btn" class="show-all-btn">Show All</button>
  </div>
  <div class="subject-grid">
    {% for subject in subjects %}
    {% if subject.scroll_count > 0 %}
    {{ subject_card(subject.name, subject.scroll_count) }}
    {% endif %}
    {% endfor %}
  </div>
</div>

<div class="recent" id="recent">
  <h2 id="recent-submissions-heading">Recent Scrolls</h2>
  
  <div class="scrolls-grid">
    {% for preview_row in scrolls %}
    {% set preview = preview_row[0] %}
    {% set subject_name = preview_row[1] %}
    {{ scroll_card(
                    preview.title,
                    preview.authors,
                    preview.abstract,
                    preview.keywords,
                    subject_name,
                    "recently",
                    "v" + preview.version|string,
                    preview.url_hash
       ) }}
    {% endfor %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const subjectCards = document.querySelectorAll('.subject-card');
    const previewCards = document.querySelectorAll('.preview');
    const headingElement = document.getElementById('recent-submissions-heading');
    const showAllBtn = document.getElementById('show-all-btn');
    let currentSubject = null;

    // Get subject from URL parameters
    function getSubjectFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('subject');
    }

    // Update URL without page reload
    function updateURL(subject) {
        const url = new URL(window.location);
        if (subject) {
            url.searchParams.set('subject', subject);
        } else {
            url.searchParams.delete('subject');
        }
        window.history.pushState({}, '', url);
    }

    // Filter scrolls by subject (fetch new data)
    async function filterPreviews(subjectName) {
        const scrollsGrid = document.querySelector('.scrolls-grid');
        
        try {
            // Build API URL
            let apiUrl = '/api/scrolls';
            if (subjectName) {
                apiUrl += `?subject=${encodeURIComponent(subjectName)}`;
                console.log('Subject name being sent to API:', subjectName);
            }
            
            // Fetch filtered scrolls
            const response = await fetch(apiUrl);
            const data = await response.json();
            
            // Clear existing scrolls
            scrollsGrid.innerHTML = '';
            
            // Add new scrolls
            data.scrolls.forEach(scroll => {
                const scrollCard = createScrollCard(scroll);
                scrollsGrid.appendChild(scrollCard);
            });
            
            // Debug: Show number of cards created
            if (data.scrolls.length === 0) {
                scrollsGrid.innerHTML = '<p style="color: #666; text-align: center; padding: 2rem;">No scrolls found for this subject.</p>';
            }
            
            // Update preview cards reference
            window.previewCards = document.querySelectorAll('.preview');
            
        } catch (error) {
            console.error('Error fetching scrolls:', error);
        }
    }
    
    // Create scroll card HTML element
    function createScrollCard(scroll) {
        const div = document.createElement('div');
        div.className = 'scroll preview';
        div.setAttribute('data-subject', scroll.subject_name.toLowerCase().replace(' ', '-'));
        
        const tagsHtml = scroll.keywords.map(tag => `<span class="tag">${tag}</span>`).join('');
        const timeAgo = 'recently'; // You might want to calculate this properly
        
        div.innerHTML = `
            <a href="/scroll/${scroll.url_hash}" class="scroll-link">
                <div class="scroll-title">${scroll.title}</div>
            </a>
            <div class="scroll-authors">${scroll.authors}</div>
            <div class="scroll-abstract">${scroll.abstract}</div>
            <div class="scroll-footer">
                <div class="scroll-tags">${tagsHtml}</div>
                <div class="scroll-meta">
                    <span class="preview-subject-link" data-subject-name="${scroll.subject_name.toLowerCase().replace(' ', '-')}" data-subject-display="${scroll.subject_name}" style="color: var(--red); cursor: pointer;">${scroll.subject_name}</span> | 
                    Submitted ${timeAgo} | 
                    <span style="color: var(--red);">v${scroll.version}</span>
                </div>
            </div>
        `;
        
        return div;
    }

    // Update heading text
    function updateHeading(subjectDisplay) {
        if (subjectDisplay) {
            headingElement.textContent = `Recent ${subjectDisplay} Scrolls`;
        } else {
            headingElement.textContent = 'Recent Scrolls';
        }
    }

    // Update selected subject card
    function updateSelectedCard(selectedCard) {
        subjectCards.forEach(card => card.classList.remove('selected'));
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }
    }

    // Update show all button state
    function updateShowAllButton(isActive) {
        if (isActive) {
            showAllBtn.classList.add('active');
        } else {
            showAllBtn.classList.remove('active');
        }
    }

    // Select subject
    async function selectSubject(subjectName, subjectDisplay, card) {
        if (currentSubject === subjectName) {
            // Deselect if clicking the same subject
            currentSubject = null;
            updateSelectedCard(null);
            await filterPreviews(null);
            updateHeading(null);
            updateURL(null);
            updateShowAllButton(true);
        } else {
            // Select new subject
            currentSubject = subjectName;
            updateSelectedCard(card);
            await filterPreviews(subjectDisplay); // Use display name for API call
            updateHeading(subjectDisplay);
            updateURL(subjectName);
            updateShowAllButton(false);
        }
    }

    // Show all subjects
    async function showAll() {
        currentSubject = null;
        updateSelectedCard(null);
        await filterPreviews(null);
        updateHeading(null);
        updateURL(null);
        updateShowAllButton(true);
    }

    // Add click handlers to subject cards
    subjectCards.forEach(card => {
        card.addEventListener('click', async function() {
            const subjectName = this.dataset.subjectName;
            const subjectDisplay = this.dataset.subjectDisplay;
            await selectSubject(subjectName, subjectDisplay, this);
        });
    });

    // Add click handler to show all button
    showAllBtn.addEventListener('click', async function() {
        // Only allow click if button is not in active (disabled) state
        if (!showAllBtn.classList.contains('active')) {
            await showAll();
        }
    });

    // Add click handlers to preview subject links
    document.addEventListener('click', async function(e) {
        if (e.target.classList.contains('preview-subject-link')) {
            e.preventDefault();
            const subjectName = e.target.dataset.subjectName;
            const subjectDisplay = e.target.dataset.subjectDisplay;
            
            // Find the matching subject card
            const matchingCard = Array.from(subjectCards).find(card => 
                card.dataset.subjectName === subjectName
            );
            
            await selectSubject(subjectName, subjectDisplay, matchingCard);
        }
    });

    // Initialize from URL parameters
    (async function() {
        const urlSubject = getSubjectFromURL();
        if (urlSubject) {
            const matchingCard = Array.from(subjectCards).find(card => 
                card.dataset.subjectName === urlSubject
            );
            if (matchingCard) {
                const subjectDisplay = matchingCard.dataset.subjectDisplay;
                await selectSubject(urlSubject, subjectDisplay, matchingCard);
            }
        } else {
            // Initialize with "Show All" active
            updateShowAllButton(true);
        }
    })();
});
</script>
{% endblock %}
