{% extends "base.html" %}
{% from "components/button.html" import button %}
{% from "components/preview_card.html" import preview_card %}
{% from "components/subject_card.html" import subject_card %}
{% from "components/search_form.html" import search_form %}

{% block title %}Home - Press{% endblock %}

{% block content %}
<div class="hero">
  <div class="hero-title">
    <img src="/static/images/press-logo-64.svg" alt="Scroll Press" width="40" height="40">
    <h1>Scroll Press</h1>
  </div>
  <p>Open access to research preprints in web-native formats</p>
  
  <div class="search-box">
    {{ search_form(button_class="search-btn-override") }}
    <div class="search-help">
      Search includes titles, authors, abstracts, and full text
    </div>
  </div>
</div>

<div class="subjects" id="browse">
  <div class="subjects-header">
    <h2>Browse by Subject</h2>
    <button id="show-all-btn" class="show-all-btn">Show All</button>
  </div>
  <div class="subject-grid">
    {% for subject in subjects %}
    {{ subject_card(subject.name, subject.scroll_count) }}
    {% endfor %}
  </div>
</div>

<div class="recent" id="recent">
  <h2 id="recent-submissions-heading">Recent Scrolls</h2>
  
  <div class="scrolls-grid">
    {% for preview_row in previews %}
    {% set preview = preview_row[0] %}
    {% set subject_name = preview_row[1] %}
    {{ preview_card(
                    preview.title,
                    preview.authors,
                    preview.abstract,
                    preview.keywords,
                    subject_name,
                    "recently",
                    "v" + preview.version|string,
                    preview.preview_id
       ) }}
    {% endfor %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const subjectCards = document.querySelectorAll('.subject-card');
    const previewCards = document.querySelectorAll('.preview');
    const headingElement = document.getElementById('recent-submissions-heading');
    const showAllBtn = document.getElementById('show-all-btn');
    let currentSubject = null;

    // Get subject from URL parameters
    function getSubjectFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('subject');
    }

    // Update URL without page reload
    function updateURL(subject) {
        const url = new URL(window.location);
        if (subject) {
            url.searchParams.set('subject', subject);
        } else {
            url.searchParams.delete('subject');
        }
        window.history.pushState({}, '', url);
    }

    // Filter scrolls by subject
    function filterPreviews(subjectName) {
        previewCards.forEach(card => {
            const cardSubject = card.dataset.subject;
            if (!subjectName || cardSubject === subjectName) {
                card.style.display = 'block';
                card.classList.remove('filtered-out');
            } else {
                card.style.display = 'none';
                card.classList.add('filtered-out');
            }
        });
    }

    // Update heading text
    function updateHeading(subjectDisplay) {
        if (subjectDisplay) {
            headingElement.textContent = `Recent ${subjectDisplay} Scrolls`;
        } else {
            headingElement.textContent = 'Recent Scrolls';
        }
    }

    // Update selected subject card
    function updateSelectedCard(selectedCard) {
        subjectCards.forEach(card => card.classList.remove('selected'));
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }
    }

    // Update show all button state
    function updateShowAllButton(isActive) {
        if (isActive) {
            showAllBtn.classList.add('active');
        } else {
            showAllBtn.classList.remove('active');
        }
    }

    // Select subject
    function selectSubject(subjectName, subjectDisplay, card) {
        if (currentSubject === subjectName) {
            // Deselect if clicking the same subject
            currentSubject = null;
            updateSelectedCard(null);
            filterPreviews(null);
            updateHeading(null);
            updateURL(null);
            updateShowAllButton(true);
        } else {
            // Select new subject
            currentSubject = subjectName;
            updateSelectedCard(card);
            filterPreviews(subjectName);
            updateHeading(subjectDisplay);
            updateURL(subjectName);
            updateShowAllButton(false);
        }
    }

    // Show all subjects
    function showAll() {
        currentSubject = null;
        updateSelectedCard(null);
        filterPreviews(null);
        updateHeading(null);
        updateURL(null);
        updateShowAllButton(true);
    }

    // Add click handlers to subject cards
    subjectCards.forEach(card => {
        card.addEventListener('click', function() {
            const subjectName = this.dataset.subjectName;
            const subjectDisplay = this.dataset.subjectDisplay;
            selectSubject(subjectName, subjectDisplay, this);
        });
    });

    // Add click handler to show all button
    showAllBtn.addEventListener('click', function() {
        // Only allow click if button is not in active (disabled) state
        if (!showAllBtn.classList.contains('active')) {
            showAll();
        }
    });

    // Add click handlers to preview subject links
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('preview-subject-link')) {
            e.preventDefault();
            const subjectName = e.target.dataset.subjectName;
            const subjectDisplay = e.target.dataset.subjectDisplay;
            
            // Find the matching subject card
            const matchingCard = Array.from(subjectCards).find(card => 
                card.dataset.subjectName === subjectName
            );
            
            selectSubject(subjectName, subjectDisplay, matchingCard);
        }
    });

    // Initialize from URL parameters
    const urlSubject = getSubjectFromURL();
    if (urlSubject) {
        const matchingCard = Array.from(subjectCards).find(card => 
            card.dataset.subjectName === urlSubject
        );
        if (matchingCard) {
            const subjectDisplay = matchingCard.dataset.subjectDisplay;
            selectSubject(urlSubject, subjectDisplay, matchingCard);
        }
    } else {
        // Initialize with "Show All" active
        updateShowAllButton(true);
    }
});
</script>
{% endblock %}
